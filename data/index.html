<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–¢–∞–±–ª–æ –∑–∞ –£–º–µ–Ω –î–æ–º</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script src="dashboard-config.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <header class="header">
            <h1>–¢–∞–±–ª–æ –∑–∞ –£–º–µ–Ω –î–æ–º</h1>
            <div class="status-indicators">
                <div class="status-indicator">
                    <div class="status-dot" id="mqtt-status"></div>
                    <span id="mqtt-text">MQTT: –ü—Ä–µ–∫—ä—Å–Ω–∞—Ç</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot" id="wifi-status"></div>
                    <span id="wifi-text">WiFi: –ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω</span>
                </div>
                <div class="status-indicator">
                    <div class="status-dot" id="rain-status-dot"></div>
                    <span id="rain-status-text">–î—ä–∂–¥: –ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω</span>
                </div>
                <button class="theme-toggle" onclick="toggleTheme()">üåô</button>
            </div>
        </header>

        <div class="error-message" id="error-message"></div>
        <div class="success-message" id="success-message"></div>

        <!-- Rain Popup Notification -->
        <div class="rain-popup-overlay" id="rain-popup-overlay"></div>
        <div class="rain-popup" id="rain-popup">
            <div class="rain-popup-emoji">‚òÅÔ∏èüåßÔ∏è</div>
            <div class="rain-popup-title">–î—ä–∂–¥ –ó–∞—Å–µ—á–µ–Ω!</div>
            <div class="rain-popup-message">–í –º–æ–º–µ–Ω—Ç–∞ –≤–∞–ª–∏ –Ω–∞–≤—ä–Ω</div>
            <div class="rain-popup-details" id="rain-popup-details">
                –°—Ç–æ–π–Ω–æ—Å—Ç –Ω–∞ –°–µ–Ω–∑–æ—Ä–∞: <span id="rain-popup-value">--</span><br>
                –ó–∞—Å–µ—á–µ–Ω–æ –≤: <span id="rain-popup-time">--</span>
            </div>
            <button class="rain-popup-close" onclick="closeRainPopup()">–†–∞–∑–±—Ä–∞–Ω–æ!</button>
        </div>

        <div class="dashboard-grid">
            <!-- Temperature Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞</h3>
                    <div class="card-icon">üå°Ô∏è</div>
                </div>
                <div class="sensor-value" id="temperature">--</div>
                <div class="sensor-unit">¬∞C</div>
            </div>

            <!-- Humidity Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">–í–ª–∞–∂–Ω–æ—Å—Ç</h3>
                    <div class="card-icon">üíß</div>
                </div>
                <div class="sensor-value" id="humidity">--</div>
                <div class="sensor-unit">%</div>
            </div>



            <!-- System Status Card -->
            <div class="card">
                <div class="card-header">
                    <h3 class="card-title">–°–∏—Å—Ç–µ–º–µ–Ω –°—Ç–∞—Ç—É—Å</h3>
                    <div class="card-icon">‚ö°</div>
                </div>
                <div class="system-info">
                    <div class="info-item">
                        <span class="info-label">WiFi –°–∏–≥–Ω–∞–ª</span>
                        <span class="info-value" id="wifi-rssi">-- dBm</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">–°–≤–æ–±–æ–¥–Ω–∞ –ü–∞–º–µ—Ç</span>
                        <span class="info-value" id="free-heap">-- KB</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">–í—Ä–µ–º–µ –Ω–∞ –†–∞–±–æ—Ç–∞</span>
                        <span class="info-value" id="uptime">--</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">–ü–æ—Å–ª–µ–¥–Ω–∞ –ê–∫—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è</span>
                        <span class="info-value" id="last-update">--</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="controls-grid">
            <!-- Light Controls -->
            <div class="control-card">
                <div class="card-header">
                    <h3 class="card-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–∞ –û—Å–≤–µ—Ç–ª–µ–Ω–∏–µ—Ç–æ</h3>
                    <div class="card-icon">üí°</div>
                </div>
                <div class="control-item">
                    <span class="control-label">–ö—É—Ö–Ω—è </span>
                    <div class="toggle-switch" data-light="0" onclick="toggleLight(0)"></div>
                </div>
                <div class="control-item">
                    <span class="control-label">–ë–∞–Ω—è </span>
                    <div class="toggle-switch" data-light="1" onclick="toggleLight(1)"></div>
                </div>
                <div class="control-item">
                    <span class="control-label">–î–µ—Ç—Å–∫–∞ –°—Ç–∞—è </span>
                    <div class="toggle-switch" data-light="2" onclick="toggleLight(2)"></div>
                </div>
                <div class="control-item">
                    <span class="control-label">–°–ø–∞–ª–Ω—è</span>
                    <div class="toggle-switch" data-light="3" onclick="toggleLight(3)"></div>
                </div>
            </div>

            <!-- Alarm Control -->
            <div class="control-card">
                <div class="card-header">
                    <h3 class="card-title">–°–∏–≥—É—Ä–Ω–æ—Å—Ç</h3>
                    <div class="card-icon">üîî</div>
                </div>
                <div class="control-item">
                    <span class="control-label">–ê–ª–∞—Ä–º–∞</span>
                    <div class="toggle-switch" id="buzzer-toggle" onclick="toggleBuzzer()"></div>
                </div>
                <div style="margin-top: 16px;">
                    <button class="action-button danger" onclick="emergencyStop()">
                        üö® –°–ø–∏—Ä–∞–Ω–µ –Ω–∞ –ê–≤–∞—Ä–∏—è—Ç–∞
                    </button>
                    <button class="action-button" onclick="testConnection()" style="background: #34C759;">
                        üß™ –¢–µ—Å—Ç MQTT
                    </button>
                    <button class="action-button" onclick="testRainSensor()" style="background: #007AFF;">
                        üåßÔ∏è –¢–µ—Å—Ç –î—ä–∂–¥
                    </button>
                    <button class="action-button" onclick="showConnectionInfo()" style="background: #FF9500;">
                        ‚ÑπÔ∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –í—Ä—ä–∑–∫–∞—Ç–∞
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // MQTT Configuration - Load from config file or use default
        const MQTT_CONFIG = typeof DASHBOARD_CONFIG !== 'undefined' ? DASHBOARD_CONFIG.mqtt : {
            host: '7fad8ef106584fd6951e4a14e11fc5ea.s1.eu.hivemq.cloud',
            port: 8884,                 // WebSocket port for HiveMQ Cloud
            protocol: 'wss',            // Secure WebSocket
            username: 'PenkovXD_19',
            password: 'FYK_hxf2dct.emu@afc',
            secure: true,
        };

        let mqttClient = null;
        let isConnected = false;
        let sensorData = {
            temperature: null,
            humidity: null,
            rain: null,
            system: null
        };
        let lightStates = [false, false, false, false];
        let buzzerState = false;

        // Initialize MQTT connection
        function initMQTT() {
            const brokerUrl = `${MQTT_CONFIG.protocol}://${MQTT_CONFIG.host}:${MQTT_CONFIG.port}/mqtt`;
            
            const options = {
                clientId: 'dashboard_' + Math.random().toString(16).substr(2, 8),
                reconnectPeriod: 5000,
                connectTimeout: 10000,
            };

            // Add credentials if provided
            if (MQTT_CONFIG.username) {
                options.username = MQTT_CONFIG.username;
                options.password = MQTT_CONFIG.password;
            }

            mqttClient = mqtt.connect(brokerUrl, options);

            mqttClient.on('connect', () => {
                console.log('–°–≤—ä—Ä–∑–∞–Ω –∫—ä–º MQTT —Å—ä—Ä–≤—ä—Ä–∞');
                isConnected = true;
                updateConnectionStatus(true);
                subscribeToTopics();
                showSuccess('–£—Å–ø–µ—à–Ω–æ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ –∫—ä–º MQTT —Å—ä—Ä–≤—ä—Ä–∞');
            });

            mqttClient.on('error', (error) => {
                console.error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ MQTT –≤—Ä—ä–∑–∫–∞—Ç–∞:', error);
                isConnected = false;
                updateConnectionStatus(false);
                showError('MQTT –≤—Ä—ä–∑–∫–∞—Ç–∞ –Ω–µ—É—Å–ø–µ—à–Ω–∞: ' + error.message);
            });

            mqttClient.on('offline', () => {
                console.log('MQTT –∫–ª–∏–µ–Ω—Ç—ä—Ç –µ –æ—Ñ–ª–∞–π–Ω');
                isConnected = false;
                updateConnectionStatus(false);
                showError('MQTT —Å—ä—Ä–≤—ä—Ä—ä—Ç –µ –∏–∑–∫–ª—é—á–µ–Ω');
            });

            mqttClient.on('reconnect', () => {
                console.log('–ü–æ–≤—Ç–æ—Ä–Ω–æ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ –∫—ä–º MQTT —Å—ä—Ä–≤—ä—Ä–∞...');
                showSuccess('–ü–æ–≤—Ç–æ—Ä–Ω–æ —Å–≤—ä—Ä–∑–≤–∞–Ω–µ –∫—ä–º MQTT —Å—ä—Ä–≤—ä—Ä–∞...');
            });

            mqttClient.on('message', handleMqttMessage);
        }

        function subscribeToTopics() {
            const topics = [
                'home/sensor/temperature',
                'home/sensor/humidity',
                'home/sensors/rain',
                'home/system/status',
                'home/lights/+/status',
                'home/buzzer/status'
            ];

            topics.forEach(topic => {
                mqttClient.subscribe(topic, (err) => {
                    if (err) {
                        console.error(`–ù–µ—É—Å–ø–µ—à–Ω–æ –∞–±–æ–Ω–∏—Ä–∞–Ω–µ –∑–∞ ${topic}:`, err);
                    } else {
                        console.log(`–ê–±–æ–Ω–∏—Ä–∞–Ω –∑–∞ ${topic}`);
                    }
                });
            });
        }

        function handleMqttMessage(topic, message) {
            const payload = message.toString();
            console.log(`–ü–æ–ª—É—á–µ–Ω–æ —Å—ä–æ–±—â–µ–Ω–∏–µ –æ—Ç ${topic}:`, payload);

            try {
                switch (topic) {
                    case 'home/sensor/temperature':
                        updateTemperature(parseFloat(payload));
                        break;
                    case 'home/sensor/humidity':
                        updateHumidity(parseFloat(payload));
                        break;
                    case 'home/sensors/rain':
                        updateRainSensor(JSON.parse(payload));
                        break;
                    case 'home/system/status':
                        updateSystemStatus(JSON.parse(payload));
                        break;
                    case 'home/buzzer/status':
                        updateBuzzerStatus(payload === 'ON');
                        break;
                    default:
                        if (topic.startsWith('home/lights/') && topic.endsWith('/status')) {
                            const lightIndex = parseInt(topic.split('/')[2]) - 1;
                            updateLightStatus(lightIndex, payload === 'ON');
                        }
                        break;
                }
                            } catch (error) {
                console.error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∞–Ω–∞–ª–∏–∑ –Ω–∞ MQTT —Å—ä–æ–±—â–µ–Ω–∏–µ—Ç–æ:', error);
            }
        }

        function publishMqttMessage(topic, message) {
            if (isConnected && mqttClient) {
                mqttClient.publish(topic, message, { retain: true }, (err) => {
                    if (err) {
                        console.error(`–ù–µ—É—Å–ø–µ—à–Ω–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –∫—ä–º ${topic}:`, err);
                        showError(`–ù–µ—É—Å–ø–µ—à–Ω–æ –∏–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ –∫–æ–º–∞–Ω–¥–∞—Ç–∞: ${err.message}`);
                    } else {
                        console.log(`–ò–∑–ø—Ä–∞—Ç–µ–Ω–æ –∫—ä–º ${topic}: ${message}`);
                    }
                });
            } else {
                showError('MQTT –Ω–µ –µ —Å–≤—ä—Ä–∑–∞–Ω. –ö–æ–º–∞–Ω–¥–∞—Ç–∞ –Ω–µ –º–æ–∂–µ –¥–∞ –±—ä–¥–µ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∞.');
            }
        }

        // UI Update Functions
        function updateTemperature(value) {
            sensorData.temperature = value;
            const element = document.getElementById('temperature');
            element.textContent = value !== null ? value.toFixed(1) : '--';
            element.classList.add('fade-in');
            setTimeout(() => element.classList.remove('fade-in'), 500);
        }

        function updateHumidity(value) {
            sensorData.humidity = value;
            const element = document.getElementById('humidity');
            element.textContent = value !== null ? value.toFixed(1) : '--';
            element.classList.add('fade-in');
            setTimeout(() => element.classList.remove('fade-in'), 500);
        }

        let lastRainState = false;
        let rainPopupShown = false;

        function updateRainSensor(data) {
            console.log('üåßÔ∏è –ü–æ–ª—É—á–µ–Ω–∏ –¥–∞–Ω–Ω–∏ –æ—Ç —Å–µ–Ω–∑–æ—Ä–∞ –∑–∞ –¥—ä–∂–¥:', data);
            sensorData.rain = data;
            
            // Always log the current rain status for debugging
            console.log(`–°—Ç–∞—Ç—É—Å –Ω–∞ –¥—ä–∂–¥–∞: ${data.raining ? '–í–ê–õ–ò' : '–°–£–•–û'}, –°—Ç–æ–π–Ω–æ—Å—Ç: ${data.sensor_value}, –í—Ä–µ–º–µ–≤–∞ –º–∞—Ä–∫–∞: ${data.timestamp}`);
            
            // Update rain status indicator in header
            const rainStatusDot = document.getElementById('rain-status-dot');
            const rainStatusText = document.getElementById('rain-status-text');
            
            if (data.raining) {
                rainStatusDot.classList.add('connected');
                rainStatusDot.style.background = '#FF3B30'; // Red for rain
                rainStatusText.textContent = `–î—ä–∂–¥: –ó–ê–°–ï–ß–ï–ù (${data.sensor_value})`;
                rainStatusText.style.color = '#FF3B30';
            } else {
                rainStatusDot.classList.remove('connected');
                rainStatusDot.style.background = '#34C759'; // Green for dry
                rainStatusText.textContent = `–î—ä–∂–¥: –°–£–•–û (${data.sensor_value})`;
                rainStatusText.style.color = '#34C759';
            }
            
            // Show popup when rain starts (transition from dry to raining)
            if (data.raining && !lastRainState && !rainPopupShown) {
                console.log('üåßÔ∏è –î—ä–∂–¥ –∑–∞—Å–µ—á–µ–Ω! –ü–æ–∫–∞–∑–≤–∞–Ω–µ –Ω–∞ –ø—Ä–æ–∑–æ—Ä–µ—Ü...');
                showRainPopup(data);
                rainPopupShown = true;
            }
            
            // Reset popup flag when it stops raining
            if (!data.raining && lastRainState) {
                console.log('‚òÄÔ∏è –î—ä–∂–¥—ä—Ç —Å–ø—Ä—è, –ø—Ä–æ–∑–æ—Ä–µ—Ü—ä—Ç –º–æ–∂–µ –¥–∞ —Å–µ –ø–æ–∫–∞–∂–µ –æ—Ç–Ω–æ–≤–æ —Å–ª–µ–¥–≤–∞—â–∏—è –ø—ä—Ç');
                rainPopupShown = false;
            }
            
            lastRainState = data.raining;
            updateLastUpdate();
            
            // Visual feedback in console for debugging
            if (data.raining) {
                console.log('üåßÔ∏è –í –ú–û–ú–ï–ù–¢–ê –í–ê–õ–ò - –ù–µ–æ–±—Ä–∞–±–æ—Ç–µ–Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –Ω–∞ —Å–µ–Ω–∑–æ—Ä–∞:', data.sensor_value);
            } else {
                console.log('‚òÄÔ∏è –í –º–æ–º–µ–Ω—Ç–∞ –µ —Å—É—Ö–æ - –ù–µ–æ–±—Ä–∞–±–æ—Ç–µ–Ω–∞ —Å—Ç–æ–π–Ω–æ—Å—Ç –Ω–∞ —Å–µ–Ω–∑–æ—Ä–∞:', data.sensor_value);
            }
        }

        function updateSystemStatus(data) {
            sensorData.system = data;
            
            document.getElementById('wifi-rssi').textContent = `${data.wifi_rssi || '--'} dBm`;
            document.getElementById('free-heap').textContent = `${Math.round((data.free_heap || 0) / 1024)} KB`;
            document.getElementById('uptime').textContent = formatUptime(data.uptime_ms);
            
            // Update WiFi status indicator
            const wifiStatus = document.getElementById('wifi-status');
            const wifiText = document.getElementById('wifi-text');
            if (data.wifi_rssi && data.wifi_rssi > -70) {
                wifiStatus.classList.add('connected');
                wifiText.textContent = 'WiFi: –°–∏–ª–µ–Ω';
            } else if (data.wifi_rssi) {
                wifiStatus.classList.add('connected');
                wifiText.textContent = 'WiFi: –°–ª–∞–±';
            } else {
                wifiStatus.classList.remove('connected');
                wifiText.textContent = 'WiFi: –ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω';
            }
            
            updateLastUpdate();
        }

        function updateLightStatus(index, isOn) {
            if (index >= 0 && index < 4) {
                lightStates[index] = isOn;
                const toggle = document.querySelector(`[data-light="${index}"]`);
                if (toggle) {
                    if (isOn) {
                        toggle.classList.add('active');
                    } else {
                        toggle.classList.remove('active');
                    }
                }
            }
        }

        function updateBuzzerStatus(isOn) {
            buzzerState = isOn;
            const toggle = document.getElementById('buzzer-toggle');
            if (isOn) {
                toggle.classList.add('active');
            } else {
                toggle.classList.remove('active');
            }
        }

        function updateConnectionStatus(connected) {
            const statusDot = document.getElementById('mqtt-status');
            const statusText = document.getElementById('mqtt-text');
            
            if (connected) {
                statusDot.classList.add('connected');
                statusText.textContent = 'MQTT: –°–≤—ä—Ä–∑–∞–Ω';
            } else {
                statusDot.classList.remove('connected');
                statusText.textContent = 'MQTT: –ü—Ä–µ–∫—ä—Å–Ω–∞—Ç';
            }
        }

        function updateLastUpdate() {
            const now = new Date();
            const timeString = now.toLocaleTimeString();
            document.getElementById('last-update').textContent = timeString;
        }

        // Control Functions
        function toggleLight(index) {
            const newState = !lightStates[index];
            const topic = `home/lights/${index + 1}`;
            const message = newState ? 'ON' : 'OFF';
            publishMqttMessage(topic, message);
        }

        function toggleBuzzer() {
            const newState = !buzzerState;
            const message = newState ? 'ON' : 'OFF';
            publishMqttMessage('home/buzzer/command', message);
        }

        function emergencyStop() {
            // Turn off all lights and buzzer
            for (let i = 0; i < 4; i++) {
                publishMqttMessage(`home/lights/${i + 1}`, 'OFF');
            }
            publishMqttMessage('home/buzzer/command', 'OFF');
            showSuccess('–ê–≤–∞—Ä–∏–µ–Ω —Å—Ç–æ–ø –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω - –≤—Å–∏—á–∫–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å–∞ –∏–∑–∫–ª—é—á–µ–Ω–∏');
        }

        // Utility Functions
        function formatUptime(milliseconds) {
            if (!milliseconds) return '--';
            
            const seconds = Math.floor(milliseconds / 1000);
            const minutes = Math.floor(seconds / 60);
            const hours = Math.floor(minutes / 60);
            const days = Math.floor(hours / 24);
            
            if (days > 0) return `${days}d ${hours % 24}h`;
            if (hours > 0) return `${hours}h ${minutes % 60}m`;
            if (minutes > 0) return `${minutes}m ${seconds % 60}s`;
            return `${seconds}s`;
        }

        function showError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(() => {
                errorElement.style.display = 'none';
            }, 5000);
        }

        function showSuccess(message) {
            const successElement = document.getElementById('success-message');
            successElement.textContent = message;
            successElement.style.display = 'block';
            setTimeout(() => {
                successElement.style.display = 'none';
            }, 3000);
        }

        function toggleTheme() {
            const body = document.body;
            const button = document.querySelector('.theme-toggle');
            
            if (body.hasAttribute('data-theme')) {
                body.removeAttribute('data-theme');
                button.textContent = 'üåô';
                localStorage.setItem('theme', 'light');
            } else {
                body.setAttribute('data-theme', 'dark');
                button.textContent = '‚òÄÔ∏è';
                localStorage.setItem('theme', 'dark');
            }
        }

        // Test Functions
        function testConnection() {
            console.log('–¢–µ—Å—Ç–≤–∞–Ω–µ –Ω–∞ MQTT –≤—Ä—ä–∑–∫–∞—Ç–∞...');
            console.log('–¢–µ–∫—É—â–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:', MQTT_CONFIG);
            
            // Send test data
            if (isConnected) {
                publishMqttMessage('home/sensor/temperature', '25.3');
                publishMqttMessage('home/sensor/humidity', '68.5');
                publishMqttMessage('home/sensors/rain', '{"raining": false, "sensor_value": 750, "timestamp": ' + Date.now() + '}');
                publishMqttMessage('home/system/status', '{"wifi_rssi": -42, "free_heap": 245760, "uptime_ms": 7200000, "mqtt_connected": true}');
                showSuccess('–¢–µ—Å—Ç–æ–≤–∏—Ç–µ –¥–∞–Ω–Ω–∏ —Å–∞ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∏ —É—Å–ø–µ—à–Ω–æ!');
            } else {
                showError('MQTT –Ω–µ –µ —Å–≤—ä—Ä–∑–∞–Ω. –ü—Ä–æ–≤–µ—Ä–µ—Ç–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏—Ç–µ –∑–∞ –≤—Ä—ä–∑–∫–∞.');
            }
        }

        function testRainSensor() {
            console.log('üåßÔ∏è –¢–µ—Å—Ç–≤–∞–Ω–µ –Ω–∞ —Å–µ–Ω–∑–æ—Ä–∞ –∑–∞ –¥—ä–∂–¥...');
            
            if (isConnected) {
                // Send command to ESP32 to simulate rain
                console.log('–ò–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ –î–™–ñ–î —Ç–µ—Å—Ç –∫–æ–º–∞–Ω–¥–∞ –∫—ä–º ESP32...');
                publishMqttMessage('home/sensors/rain/test', 'RAIN');
                showSuccess('–¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥–∞—Ç–∞ –∑–∞ –¥—ä–∂–¥ –µ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∞ –∫—ä–º ESP32!');
                
                // Reset to dry after 5 seconds
                setTimeout(() => {
                    console.log('–ò–∑–ø—Ä–∞—â–∞–Ω–µ –Ω–∞ –°–£–•–û —Ç–µ—Å—Ç –∫–æ–º–∞–Ω–¥–∞ –∫—ä–º ESP32...');
                    publishMqttMessage('home/sensors/rain/test', 'DRY');
                }, 5000);
            } else {
                // Local test if MQTT not connected
                console.log('MQTT –Ω–µ –µ —Å–≤—ä—Ä–∑–∞–Ω, —Ç–µ—Å—Ç–≤–∞–Ω–µ –ª–æ–∫–∞–ª–Ω–æ...');
                
                const testRainData = {
                    raining: true,
                    sensor_value: 300,  // Below threshold (500) = rain detected
                    timestamp: Math.floor(Date.now() / 1000)
                };
                
                console.log('–°–∏–º—É–ª–∏—Ä–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏ –æ—Ç —Å–µ–Ω–∑–æ—Ä–∞ –∑–∞ –¥—ä–∂–¥:', testRainData);
                updateRainSensor(testRainData);
                showSuccess('–°–µ–Ω–∑–æ—Ä—ä—Ç –∑–∞ –¥—ä–∂–¥ –µ —Ç–µ—Å—Ç–≤–∞–Ω –ª–æ–∫–∞–ª–Ω–æ (MQTT –Ω–µ –µ —Å–≤—ä—Ä–∑–∞–Ω)');
                
                // Reset after 5 seconds
                setTimeout(() => {
                    const dryData = {
                        raining: false,
                        sensor_value: 800,  // Above threshold = dry
                        timestamp: Math.floor(Date.now() / 1000)
                    };
                    console.log('–í—Ä—ä—â–∞–Ω–µ –∫—ä–º —Å—É—Ö–æ —Å—ä—Å—Ç–æ—è–Ω–∏–µ:', dryData);
                    updateRainSensor(dryData);
                }, 5000);
            }
        }

        function showConnectionInfo() {
            const brokerUrl = `${MQTT_CONFIG.protocol}://${MQTT_CONFIG.host}:${MQTT_CONFIG.port}/mqtt`;
            const rainStatus = sensorData.rain ? 
                `–î—ä–∂–¥: ${sensorData.rain.raining ? '–ó–ê–°–ï–ß–ï–ù' : '–°–£–•–û'} (–°—Ç–æ–π–Ω–æ—Å—Ç: ${sensorData.rain.sensor_value})` : 
                '–î—ä–∂–¥: –ù—è–º–∞ –ø–æ–ª—É—á–µ–Ω–∏ –¥–∞–Ω–Ω–∏';
            
            const info = `
–ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ù–ê MQTT:
- URL –Ω–∞ —Å—ä—Ä–≤—ä—Ä–∞: ${brokerUrl}
- –°—Ç–∞—Ç—É—Å –Ω–∞ –≤—Ä—ä–∑–∫–∞—Ç–∞: ${isConnected ? '–°–≤—ä—Ä–∑–∞–Ω' : '–ü—Ä–µ–∫—ä—Å–Ω–∞—Ç'}
- –ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ: ${MQTT_CONFIG.username}
- ID –Ω–∞ –∫–ª–∏–µ–Ω—Ç–∞: dashboard_${Math.random().toString(16).substr(2, 8)}

–°–¢–ê–¢–£–° –ù–ê –°–ï–ù–ó–û–†–ê –ó–ê –î–™–ñ–î:
- ${rainStatus}
- –ü—Ä–∞–≥: <500 = –î–™–ñ–î, >=500 = –°–£–•–û
- –ü–æ—Å–ª–µ–¥–µ–Ω –ø–æ–∫–∞–∑–∞–Ω –ø—Ä–æ–∑–æ—Ä–µ—Ü: ${rainPopupShown ? '–î–∞' : '–ù–µ'}
- –°—ä—Å—Ç–æ—è–Ω–∏–µ –Ω–∞ –ø—Ä–µ—Ö–æ–¥–∞: ${lastRainState ? '–ü—Ä–µ–¥–∏ —Ç–æ–≤–∞ –≤–∞–ª–µ—à–µ' : '–ü—Ä–µ–¥–∏ —Ç–æ–≤–∞ –±–µ—à–µ —Å—É—Ö–æ'}

–ê–ë–û–ù–ò–†–ê–ù–ò –¢–ï–ú–ò:
- home/sensor/temperature (–¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞)
- home/sensor/humidity (–í–ª–∞–∂–Ω–æ—Å—Ç)
- home/sensors/rain ‚≠ê (–î–∞–Ω–Ω–∏ –æ—Ç —Å–µ–Ω–∑–æ—Ä–∞ –∑–∞ –¥—ä–∂–¥)
- home/system/status (–°–∏—Å—Ç–µ–º–µ–Ω —Å—Ç–∞—Ç—É—Å)
- home/lights/+/status (–°—Ç–∞—Ç—É—Å –Ω–∞ —Å–≤–µ—Ç–ª–∏–Ω–∏—Ç–µ)
- home/buzzer/status (–°—Ç–∞—Ç—É—Å –Ω–∞ –∞–ª–∞—Ä–º–∞—Ç–∞)

ESP32 –°–ï–ù–ó–û–† –ó–ê –î–™–ñ–î:
- –ü–∏–Ω: GPIO36 (A0)
- –ü—Ä–∞–≥: 500 (–Ω–∞—Å—Ç—Ä–æ–π—Ç–µ –≤ ESP32 –∫–æ–¥–∞ –ø—Ä–∏ –Ω—É–∂–¥–∞)
- –û—á–∞–∫–≤–∞–Ω –¥–∏–∞–ø–∞–∑–æ–Ω: 0-4095 (12-–±–∏—Ç–æ–≤ ADC)
- –¢–µ—Å—Ç –∫–æ–º–∞–Ω–¥–∏: home/sensors/rain/test (RAIN/DRY/READ)

ESP32 MQTT –í–†–™–ó–ö–ê:
- –•–æ—Å—Ç: ${MQTT_CONFIG.host}
- –ü–æ—Ä—Ç: 8883 (MQTT, –Ω–µ WebSocket)
- –°—ä—â–æ—Ç–æ –ø–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ/–ø–∞—Ä–æ–ª–∞ –∫–∞—Ç–æ –≤ —Ç–∞–±–ª–æ—Ç–æ
            `;
            alert(info);
            console.log('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∑–∞ –≤—Ä—ä–∑–∫–∞—Ç–∞:', info);
        }

        // Rain Popup Functions
        function showRainPopup(rainData) {
            const overlay = document.getElementById('rain-popup-overlay');
            const popup = document.getElementById('rain-popup');
            const valueElement = document.getElementById('rain-popup-value');
            const timeElement = document.getElementById('rain-popup-time');
            
            // Update popup content
            valueElement.textContent = rainData.sensor_value || '--';
            timeElement.textContent = new Date().toLocaleTimeString();
            
            // Show popup with animation
            overlay.classList.add('show');
            popup.classList.add('show');
            
            // Auto-close after 10 seconds
            setTimeout(() => {
                if (popup.classList.contains('show')) {
                    closeRainPopup();
                }
            }, 10000);
            
            console.log('–î—ä–∂–¥ –∑–∞—Å–µ—á–µ–Ω! –ü—Ä–æ–∑–æ—Ä–µ—Ü—ä—Ç –µ –ø–æ–∫–∞–∑–∞–Ω.');
        }

        function closeRainPopup() {
            const overlay = document.getElementById('rain-popup-overlay');
            const popup = document.getElementById('rain-popup');
            
            overlay.classList.remove('show');
            popup.classList.remove('show');
        }

        // Close popup when clicking overlay
        document.addEventListener('DOMContentLoaded', function() {
            const overlay = document.getElementById('rain-popup-overlay');
            if (overlay) {
                overlay.addEventListener('click', closeRainPopup);
            }
        });

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved theme
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.setAttribute('data-theme', 'dark');
                document.querySelector('.theme-toggle').textContent = '‚òÄÔ∏è';
            }
            
            // Initialize MQTT connection
            initMQTT();
            
            // Update timestamp every second
            setInterval(updateLastUpdate, 1000);
            
            console.log('–¢–∞–±–ª–æ—Ç–æ –∑–∞ –£–º–µ–Ω –î–æ–º –µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–∞–Ω–æ');
        });
    </script>
</body>
</html> 